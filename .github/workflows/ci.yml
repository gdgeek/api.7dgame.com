name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # 阶段1: 测试
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, gd
          
      - name: Install Dependencies
        working-directory: ./advanced
        run: composer install --prefer-dist --no-progress --optimize-autoloader --ignore-platform-req=php

      - name: Prepare Test Configs
        working-directory: ./advanced
        run: |
          # Common Configs
          echo "<?php return ['vendorPath' => dirname(dirname(__DIR__)) . '/vendor'];" > common/config/main.php
          echo "<?php return ['id' => 'app-common', 'basePath' => dirname(__DIR__)];" > common/config/main-local.php
          echo "<?php return [];" > common/config/test.php
          echo "<?php return ['id' => 'app-common-tests', 'basePath' => dirname(__DIR__)];" > common/config/test-local.php
          
          # Common Codeception Config (Merges all)
          echo "<?php
          return yii\helpers\ArrayHelper::merge(
              require __DIR__ . '/main.php',
              require __DIR__ . '/main-local.php',
              require __DIR__ . '/test.php',
              require __DIR__ . '/test-local.php',
              [
                  'components' => [
                      'request' => [
                          'cookieValidationKey' => 'test-key-common',
                      ],
                  ],
              ]
          );" > common/config/codeception-local.php

          # Backend Configs
          echo "<?php return [];" > backend/config/main.php
          echo "<?php return ['id' => 'app-backend', 'basePath' => dirname(__DIR__)];" > backend/config/main-local.php
          echo "<?php return [];" > backend/config/test.php
          echo "<?php return ['id' => 'app-backend-tests', 'basePath' => dirname(__DIR__)];" > backend/config/test-local.php
          
          # Backend Codeception Config
          echo "<?php
          return yii\helpers\ArrayHelper::merge(
              require dirname(dirname(__DIR__)) . '/common/config/codeception-local.php',
              require __DIR__ . '/main.php',
              require __DIR__ . '/main-local.php',
              require __DIR__ . '/test.php',
              require __DIR__ . '/test-local.php',
              [
                  'components' => [
                      'request' => [
                          'cookieValidationKey' => 'test-key-backend',
                      ],
                  ],
              ]
          );" > backend/config/codeception-local.php

          # API Configs
          echo "<?php return [];" > api/config/main.php
          echo "<?php return ['id' => 'app-api', 'basePath' => dirname(__DIR__)];" > api/config/main-local.php
          
          # API Test Local (functions as Codeception Config for API)
          echo "<?php
          return yii\helpers\ArrayHelper::merge(
              require dirname(dirname(__DIR__)) . '/common/config/codeception-local.php',
              require __DIR__ . '/main.php',
              require __DIR__ . '/main-local.php',
              [
                  'id' => 'app-api-tests',
                  'basePath' => dirname(__DIR__),
                  'components' => [
                      'request' => [
                          'cookieValidationKey' => 'test-key-api',
                      ],
                  ],
              ]
          );" > api/config/test-local.php

      - name: Run Unit Tests
        working-directory: ./advanced
        run: |
           vendor/bin/codecept run -c common unit --bootstrap test_bootstrap.php
           vendor/bin/codecept run -c api unit --bootstrap test_bootstrap.php
           vendor/bin/codecept run -c backend unit --bootstrap test_bootstrap.php

  # 阶段2: 构建 Docker 镜像
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, gd

      - name: Install Dependencies
        working-directory: ./advanced
        run: composer install --prefer-dist --no-progress --optimize-autoloader --ignore-platform-req=php
      
      - name: Login to Tencent Registry
        uses: docker/login-action@v3
        with:
          registry: hkccr.ccs.tencentyun.com
          username: ${{ secrets.TENCENT_DOCKER_USERNAME }}
          password: ${{ secrets.TENCENT_DOCKER_PASSWORD }}
          
      - name: Build and Push Docker Image
        run: |
          docker build -t hkccr.ccs.tencentyun.com/gdgeek/api:${{ github.sha }} -f docker/Release .
          docker tag hkccr.ccs.tencentyun.com/gdgeek/api:${{ github.sha }} hkccr.ccs.tencentyun.com/gdgeek/api:latest
          docker push hkccr.ccs.tencentyun.com/gdgeek/api:${{ github.sha }}
          docker push hkccr.ccs.tencentyun.com/gdgeek/api:latest

  # 阶段3: 部署
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    steps:
      - name: Deploy via Portainer Webhook
        run: |
          curl -X POST "${{ secrets.PORTAINER_WEBHOOK_URL }}"
