{"version":3,"file":"auto-arrange-plugin.common.js","sources":["../src/board.js","../src/cache.js","../src/auto-arrange.js","../src/index.js"],"sourcesContent":["export class Board {\n    constructor() {\n        this._cols = [];\n    }\n\n    add(columnIndex, value) {\n        if (!this._cols[columnIndex]) this._cols[columnIndex] = [];\n        \n        this._cols[columnIndex].push(value);\n    }\n\n    toArray() {\n        const normalized = Object.keys(this._cols)\n            .sort((i1, i2) => +i1 - +i2)\n            .map(key => this._cols[key]);\n\n        return normalized;\n    }\n}\n","export class Cache {\n    constructor() {\n        this._map = new WeakMap();\n    }\n\n    track(value) {\n        if (this._map.has(value)) return true;\n        this._map.set(value, true);\n    }\n}\n","import { Board } from './board';\nimport { Cache } from './cache';\n\nexport class AutoArrange {\n    constructor(editor, margin, depth, vertical) {\n        this.editor = editor;\n        this.margin = margin;\n        this.depth = depth;\n        this.vertical = vertical;\n    }\n\n    getNodes(node, type = 'output') {\n        const nodes = [];\n        const key = `${type}s`;\n\n        for (let io of node[key].values())\n            for (let connection of io.connections.values())\n                nodes.push(connection[type === 'input' ? 'output' : 'input'].node);\n            \n        return nodes;\n    }\n\n    getNodesBoard(node, cache = new Cache(), board = new Board(), depth = 0) {\n        if (this.depth && depth > this.depth) return;\n        if (cache.track(node)) return;\n\n        board.add(depth, node);\n        \n        this.getNodes(node, 'output').map(n => this.getNodesBoard(n, cache, board, depth + 1));\n        this.getNodes(node, 'input').map(n => this.getNodesBoard(n, cache, board, depth - 1));\n\n        return board;\n    }\n\n    getNodeSize(node) {\n        const el = this.editor.view.nodes.get(node).el;\n\n        return this.vertical ? {\n            height: el.clientWidth,\n            width: el.clientHeight\n        } : {\n            width: el.clientWidth,\n            height: el.clientHeight\n        }\n    }\n\n    translateNode(node, { x, y }) {\n        const position = this.vertical?[y, x]:[x, y];\n\n        this.editor.view.nodes.get(node).translate(...position);\n        this.editor.view.updateConnections({ node });\n    }\n    \n    arrange(node = this.editor.nodes[0]) {\n        const board = this.getNodesBoard(node).toArray();\n        const margin = this.vertical ? { x: this.margin.y, y: this.margin.x } : this.margin;\n\n        let x = 0;\n\n        for (let column of board) {\n            const sizes = column.map(node => this.getNodeSize(node));\n            const columnWidth  = Math.max(...sizes.map(size => size.width));\n            const fullHeight = sizes.reduce((sum, node) => sum + node.height + margin.y, 0);\n\n            let y = 0;\n\n            for (let node of column) {\n                const position = { x, y: y - fullHeight / 2 };\n                const { height } = this.getNodeSize(node);\n\n                this.translateNode(node, position);\n\n                y += height + margin.y;\n            }\n\n            x += columnWidth + margin.x;\n        }\n    }\n}","import { AutoArrange } from './auto-arrange';\n\nfunction install(editor, { margin = { x: 50, y: 50 }, depth = null, vertical = false }) {\n    editor.bind('arrange');\n\n    const ar = new AutoArrange(editor, margin, depth, vertical);\n    \n    editor.on('arrange', ({ node }) => ar.arrange(node));\n\n    editor.arrange = node => {\n        console.log(`Deprecated: use editor.trigger('arrange', { node }) instead`);\n        ar.arrange(node);\n    }\n}\n\nexport default {\n    name: 'auto-arrange',\n    install\n}"],"names":["Board","_cols","columnIndex","value","push","normalized","Object","keys","sort","i1","i2","map","key","Cache","_map","WeakMap","has","set","AutoArrange","editor","margin","depth","vertical","node","type","nodes","values","io","connections","connection","cache","board","track","add","getNodes","n","getNodesBoard","el","view","get","height","clientWidth","width","clientHeight","x","y","position","translate","updateConnections","toArray","column","sizes","getNodeSize","columnWidth","Math","max","size","fullHeight","reduce","sum","translateNode","install","bind","ar","on","arrange","console","log","name"],"mappings":"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"}